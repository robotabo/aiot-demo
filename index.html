<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIoT èª²å ‚é«”é©— (GitHubç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
        }

        header {
            width: 100%;
            padding: 15px 0;
            background: #1f1f1f;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #4cc9f0; }

        #camera-container {
            position: relative;
            width: 85vw; /* å¯¬åº¦ä½”è¢å¹• 85% */
            height: 85vw; /* æ­£æ–¹å½¢ */
            max-width: 400px;
            max-height: 400px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid #333;
            background: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* å½±ç‰‡å…ƒç´ æ¨£å¼ */
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }

        /* çµæœé¡¯ç¤ºå€ */
        #result-panel {
            margin-top: 20px;
            width: 90%;
            max-width: 400px;
        }

        #status-icon {
            font-size: 4rem;
            margin-bottom: 10px;
            display: block;
            text-shadow: 0 0 20px rgba(255,255,255,0.2);
            transition: transform 0.2s;
        }

        #class-name {
            font-size: 2rem;
            font-weight: bold;
            margin: 5px 0;
            min-height: 1.2em;
        }

        #confidence {
            font-size: 1rem;
            color: #888;
        }

        /* æŒ‰éˆ• */
        .btn-start {
            padding: 15px 50px;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #4cc9f0, #4895ef);
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-top: 100px;
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.4);
        }

        /* ç‹€æ…‹æ¨£å¼ */
        .state-normal { color: #2ecc71; }
        .state-alert { color: #e74c3c; animation: shake 0.5s infinite; }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 1. æ­¡è¿ç•«é¢ -->
    <div id="start-screen">
        <div style="margin-top: 50px;">
            <div style="font-size: 4rem;">ğŸ¤–</div>
            <h1 style="font-size: 2rem; margin-top: 20px;">AIoT é«”é©—</h1>
            <p style="color: #aaa; margin-top: 10px;">è«‹ç¢ºä¿ä½¿ç”¨ Safari æˆ– Chrome<br>ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™</p>
        </div>
        <button class="btn-start" onclick="init()">å•Ÿå‹•ç›¸æ©Ÿ</button>
    </div>

    <!-- 2. ä¸»ç¨‹å¼ç•«é¢ -->
    <div id="app-screen" class="hidden">
        <header>
            <h1>èª²å ‚å¯¦ä½œ Demo</h1>
        </header>

        <div id="camera-container">
            <!-- é€™è£¡æœƒè‡ªå‹•æ’å…¥ Video ç•«é¢ -->
        </div>

        <div id="result-panel">
            <span id="status-icon">âšª</span>
            <div id="class-name">æº–å‚™ä¸­...</div>
            <div id="confidence">ä¿¡å¿ƒæŒ‡æ•¸: 0%</div>
        </div>
    </div>

    <script>
        // ==========================================
        // æ‚¨çš„æ¨¡å‹ç¶²å€ (å·²é å¡«)
        // ==========================================
        const URL = "https://teachablemachine.withgoogle.com/models/FjqtNCUut/"; 
        // ==========================================

        let model, maxPredictions;
        let videoElement;
        let isRunning = false;
        let lastVibrate = 0;

        async function init() {
            // åˆ‡æ› UI
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');

            try {
                // 1. è¼‰å…¥æ¨¡å‹
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                
                document.getElementById('class-name').innerText = "ä¸‹è¼‰æ¨¡å‹ä¸­...";
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // 2. è¨­å®šç›¸æ©Ÿ (åŸç”Ÿå¯«æ³•ï¼Œç›¸å®¹æ€§æœ€é«˜)
                document.getElementById('class-name').innerText = "å•Ÿå‹•ç›¸æ©Ÿ...";
                
                // è¨­å®šåƒæ•¸ï¼šå„ªå…ˆä½¿ç”¨å‰é¡é ­
                const constraints = {
                    audio: false,
                    video: { facingMode: "user" }
                };

                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (e) {
                    // å¦‚æœå¤±æ•—ï¼Œå˜—è©¦ä¸æŒ‡å®šé¡é ­ (ç›¸å®¹èˆŠè£ç½®)
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                }

                // å»ºç«‹ Video å…ƒç´ 
                videoElement = document.createElement('video');
                videoElement.setAttribute('playsinline', ''); // iOS é—œéµ
                videoElement.setAttribute('autoplay', '');
                videoElement.setAttribute('muted', '');
                videoElement.srcObject = stream;

                // ç­‰å¾…ä¸²æµè¼‰å…¥
                await new Promise((resolve) => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play();
                        resolve();
                    };
                });

                // å°‡ Video æ”¾é€²ç•«é¢
                document.getElementById("camera-container").appendChild(videoElement);
                
                // é–‹å§‹è¿´åœˆ
                isRunning = true;
                requestAnimationFrame(loop);

            } catch (error) {
                alert("å•Ÿå‹•å¤±æ•—ï¼\nè«‹æª¢æŸ¥ï¼š\n1. æ˜¯å¦ä½¿ç”¨ Safari/Chromeï¼Ÿ\n2. æ˜¯å¦å…è¨±ç›¸æ©Ÿæ¬Šé™ï¼Ÿ\n\néŒ¯èª¤è¨Šæ¯ï¼š" + error.message);
                location.reload();
            }
        }

        async function loop() {
            if (isRunning) {
                await predict();
                requestAnimationFrame(loop);
            }
        }

        async function predict() {
            if (!model || !videoElement) return;

            // é æ¸¬
            const prediction = await model.predict(videoElement);
            
            // æ‰¾å‡ºæœ€é«˜åˆ†çš„é¡åˆ¥
            let bestClass = "";
            let highestProb = 0;
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestProb) {
                    highestProb = prediction[i].probability;
                    bestClass = prediction[i].className;
                }
            }

            // æ›´æ–°ç•«é¢
            const icon = document.getElementById('status-icon');
            const name = document.getElementById('class-name');
            const conf = document.getElementById('confidence');

            name.innerText = bestClass;
            conf.innerText = `ä¿¡å¿ƒæŒ‡æ•¸: ${(highestProb * 100).toFixed(0)}%`;

            // é‚è¼¯åˆ¤æ–· (é–€æª»å€¼ 0.8)
            if (highestProb > 0.8) {
                // Class 1 (é€šå¸¸æ˜¯æ­£å¸¸/å®‰å…¨)
                if (prediction[0].probability > 0.8) {
                    icon.innerText = "ğŸ›¡ï¸";
                    name.style.color = "#2ecc71"; // ç¶ è‰²
                    icon.className = ""; // åœæ­¢éœ‡å‹•å‹•ç•«
                } 
                // Class 2 (é€šå¸¸æ˜¯è§¸ç™¼/è­¦å ±)
                else if (prediction[1] && prediction[1].probability > 0.8) {
                    icon.innerText = "ğŸš¨";
                    name.style.color = "#e74c3c"; // ç´…è‰²
                    icon.className = "state-alert"; // é–‹å•Ÿéœ‡å‹•å‹•ç•«

                    // æ‰‹æ©Ÿéœ‡å‹•å›é¥‹ (IoT æ•ˆæœ)
                    const now = Date.now();
                    if (now - lastVibrate > 1000) { // å†·å»æ™‚é–“ 1ç§’
                        if (navigator.vibrate) navigator.vibrate(200);
                        lastVibrate = now;
                    }
                }
            } else {
                icon.innerText = "ğŸ¤”";
                name.style.color = "white";
                icon.className = "";
            }
        }
    </script>
</body>
</html>